
<!DOCTYPE html>
<html>


<head>

  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Improved R Profiling Summaries</title>
  <link rel="canonical" href="/archives/2013-05-02-improved-r-profiling-summaries/" />

  
  <link rel="stylesheet" href="/assets/css/kube.css" />
  <link rel="stylesheet" href="/assets/css/custom.css" />
  <link rel="stylesheet" href="/assets/css/tufte.css" />

  
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400italic,400,700,700italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya+SC:400&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=IM+Fell+English:400,400i&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
  <link href="/assets/fonts/fell-flowers/style.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hack-font@3/build/web/hack-subset.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.0/css/academicons.min.css">
  <link href="/assets/fonts/fontawesome/css/all.css" rel="stylesheet">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="shortcut icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="shortcut icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="manifest" href="/assets/site.webmanifest">
  <link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#2b5797">
  <meta name="theme-color" content="#ffffff">

  
  

  
  <meta name="description" content="In my [last post](http://www.noamross.net/blog/2013/4/25/faster-talk.html) I mentioned that I had improved on R&#39;s `summaryRprof()` function with a custom function called `proftable()`. I&#39;ve updated `proftable()` to take advantage of R 3.0.0&#39;s ability to record line numbers while profiling. I&#39;ve put it on github -- you can get it [there](https://github.com/noamross/noamtools/blob/master/R/proftable.R) or below. `proftable` reads in a file generated by `Rprof()` and creates an easy-to read table of the most time-consuming calls in your code, ordered from most time-consuming to least.
" />

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/archives/2013-05-02-improved-r-profiling-summaries/">
  <meta name="twitter:title" content="Improved R Profiling Summaries">
  <meta name="twitter:description" content="In my [last post](http://www.noamross.net/blog/2013/4/25/faster-talk.html) I mentioned that I had improved on R&#39;s `summaryRprof()` function with a custom function called `proftable()`. I&#39;ve updated `proftable()` to take advantage of R 3.0.0&#39;s ability to record line numbers while profiling. I&#39;ve put it on github -- you can get it [there](https://github.com/noamross/noamtools/blob/master/R/proftable.R) or below. `proftable` reads in a file generated by `Rprof()` and creates an easy-to read table of the most time-consuming calls in your code, ordered from most time-consuming to least.">
  <meta name="twitter:image" content="/assets/img/nr.png">
  <meta name="twitter:site" content="trang1618.github.io">
  <meta name="twitter:creator" content="@trang1618">

  <meta property="og:title" content="Improved R Profiling Summaries" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="trang1618.github.io" />
  <meta property="og:description" content="  In my [last post](http://www.noamross.net/blog/2013/4/25/faster-talk.html) I mentioned that I had improved on R&#39;s `summaryRprof()` function with a custom function called `proftable()`. I&#39;ve updated `proftable()` to take advantage of R 3.0.0&#39;s ability to record line numbers while profiling. I&#39;ve put it on github -- you can get it [there](https://github.com/noamross/noamtools/blob/master/R/proftable.R) or below. `proftable` reads in a file generated by `Rprof()` and creates an easy-to read table of the most time-consuming calls in your code, ordered from most time-consuming to least." />
  <meta property="og:url" content="/archives/2013-05-02-improved-r-profiling-summaries/" />
  <script type="application/ld+json">
    {"@type":"WebSite","url":"\/archives\/2013-05-02-improved-r-profiling-summaries\/","headline":"Improved R Profiling Summaries", "name":"trang1618.github.io","description":"In my [last post](http:\/\/www.noamross.net\/blog\/2013\/4\/25\/faster-talk.html) I mentioned that I had improved on R\x27s `summaryRprof()` function with a custom function called `proftable()`. I\x27ve updated `proftable()` to take advantage of R 3.0.0\x27s ability to record line numbers while profiling. I\x27ve put it on github -- you can get it [there](https:\/\/github.com\/noamross\/noamtools\/blob\/master\/R\/proftable.R) or below. `proftable` reads in a file generated by `Rprof()` and creates an easy-to read table of the most time-consuming calls in your code, ordered from most time-consuming to least.","@context":"http://schema.org"}
  </script>

  
  
</head>

<body>

<div id="topbar" class="is-hidden-print">
	<div class="wrapper">
		<header>
			<div class="is-navbar-container">
				<nav>
				<div class="is-brand">
					<a href="/">t  r  a  n  g </a>
					<a href="#"
						 class="is-push-right-mobile is-shown-mobile icon-kube-menu"
						 data-kube="toggle"
						 data-target="#navbar-main"></a>
				</div>
				</nav>
				<div id="navbar-main" class="is-navbar is-hidden-mobile is-center-mobile">
					<nav>
						<ul>
							<li><a href="/blog">blog</a></li>
						
							<li><a href="/vitae">vitae</a></li>
							<li><a href="#connect">connect</a></li>
						</ul>
					</nav>
				</div>
			</div>
		</header>
	</div>
</div>


<div class="wrapper">
  <div class="is-row is-stack-20">
    <div class="is-col is-10">&nbsp;</div>
    <div class="is-col is-60">
    <h1 class="is-text-center"><a href="">Improved R Profiling Summaries</a></h1>
    <h4 class="is-bigger is-text-center">May 2, 2013</h4>
    </div>
    <div class="is-col is-30">&nbsp;</div>
  </div>
  <div class="is-row is-stack-20">
  </div>
  <div class="is-row is-stack-20">
    <div class="is-col is-10 dateblock is-stack-20">
    </div>
    <div class="is-col is-60">
      <div class="story">
       


In my [last
post](http://www.noamross.net/blog/2013/4/25/faster-talk.html) I
mentioned that I had improved on R's `summaryRprof()` function with a
custom function called `proftable()`. I've updated `proftable()` to take
advantage of R 3.0.0's ability to record line numbers while profiling.
I've put it on github -- you can get it
[there](https://github.com/noamross/noamtools/blob/master/R/proftable.R)
or below.

`proftable` reads in a file generated by `Rprof()` and creates an
easy-to read table of the most time-consuming calls in your code,
ordered from most time-consuming to least. Unlike `summaryRprof()`, it
prints the *entire call stack*, so you can trace the origin of the time
hogs. To make this easier to read, I lop off the "parent stack" common
to all of the function calls, and display it just once, below the table.
Here's some example output:

    > Rprof("profile1.out", line.profiling=TRUE)
    > source("http://pastebin.com/download.php?i=KjdkSVZq")
    > Rprof(NULL)
    > proftable("profile1.out", lines=10)

     PctTime Call                                                      
     20.47   1#17 > [ > 1#17 > [.data.frame                            
      9.73   1#17 > [ > 1#17 > [.data.frame > [ > [.factor             
      8.72   1#17 > [ > 1#17 > [.data.frame > [ > [.factor > NextMethod
      8.39   == > Ops.factor                                           
      5.37   ==                                                        
      5.03   == > Ops.factor > noNA.levels > levels                    
      4.70   == > Ops.factor > NextMethod                              
      4.03   1#17 > [ > 1#17 > [.data.frame > [ > [.factor > levels    
      4.03   1#17 > [ > 1#17 > [.data.frame > dim                      
      3.36   1#17 > [ > 1#17 > [.data.frame > length                   

    #File 1: http://pastebin.com/download.php?i=KjdkSVZq

    Parent Call: source > withVisible > eval > eval >

    Total Time: 5.96 seconds
    Percent of run time represented: 73.8 %

Note that the "Parent Call" at the bottom shows some functions which
RStudio wrapped my code in. Also, I chose only to display the top 10
time-consuming calls, but `proftable` told me that those 10 calls
represent 73.8% of the run time. I find this display a lot more
intuitive than `summaryRprof()`

Here's the whole function. If you have improvements, [fork it on
github](https://github.com/noamross/noamtools/blob/master/R/proftable.R):

    proftable <- function(file, lines=10) {
    # require(plyr)
      interval <- as.numeric(strsplit(readLines(file, 1), "=")[[1L]][2L])/1e+06
      profdata <- read.table(file, header=FALSE, sep=" ", comment.char = "",
                             colClasses="character", skip=1, fill=TRUE,
                             na.strings="")
      filelines <- grep("#File", profdata[,1])
      files <- aaply(as.matrix(profdata[filelines,]), 1, function(x) {
                            paste(na.omit(x), collapse = " ") })
      profdata <- profdata[-filelines,]
      total.time <- interval*nrow(profdata)
      profdata <- as.matrix(profdata[,ncol(profdata):1])
      profdata <- aaply(profdata, 1, function(x) {
                          c(x[(sum(is.na(x))+1):length(x)],
                            x[seq(from=1,by=1,length=sum(is.na(x)))])
                  })
      stringtable <- table(apply(profdata, 1, paste, collapse=" "))
      uniquerows <- strsplit(names(stringtable), " ")
      uniquerows <- llply(uniquerows, function(x) replace(x, which(x=="NA"), NA))
      dimnames(stringtable) <- NULL
      stacktable <- ldply(uniquerows, function(x) x)
      stringtable <- stringtable/sum(stringtable)*100
      stacktable <- data.frame(PctTime=stringtable[], stacktable)
      stacktable <- stacktable[order(stringtable, decreasing=TRUE),]
      rownames(stacktable) <- NULL
      stacktable <- head(stacktable, lines)
      na.cols <- which(sapply(stacktable, function(x) all(is.na(x))))
      stacktable <- stacktable[-na.cols]
      parent.cols <- which(sapply(stacktable, function(x) length(unique(x)))==1)
      parent.call <- paste0(paste(stacktable[1,parent.cols], collapse = " > ")," >")
      stacktable <- stacktable[,-parent.cols]
      calls <- aaply(as.matrix(stacktable[2:ncol(stacktable)]), 1, function(x) {
                       paste(na.omit(x), collapse= " > ")
                         })
      stacktable <- data.frame(PctTime=stacktable$PctTime, Call=calls)
      frac <- sum(stacktable$PctTime)
      attr(stacktable, "total.time") <- total.time
      attr(stacktable, "parent.call") <- parent.call
      attr(stacktable, "files") <- files
      attr(stacktable, "total.pct.time") <- frac
      cat("\n")
      print(stacktable, row.names=FALSE, right=FALSE, digits=3)
      cat("\n")
      cat(paste(files, collapse="\n"))
      cat("\n")
      cat(paste("\nParent Call:", parent.call))
      cat(paste("\n\nTotal Time:", total.time, "seconds\n"))
      cat(paste0("Percent of run time represented: ", format(frac, digits=3)), "%")

      invisible(stacktable)
    }

      </div>
      <hr>
      
      <a href="/archives/2013-04-25-faster-talk/"> &larr;&nbsp;FasteR! HigheR! StrongeR! - A Guide to Speeding Up R Code for Busy People</a> |
      
      <a href="//blog/#2013">All posts</a>
      
      | <a href="/archives/2013-05-23-robert-hijmans-on-spatial-data-analysis/">Robert Hijmans on Spatial Data Analysis&nbsp;&rarr;</a>
      
    </div>
    <div class="is-col is-30"></div>

  </div>
</div>



<footer id="footer" class="is-hidden-print">
  <div class="wrapper">
    <div class="is-row .is-small is-muted">
      <div class="is-col is-33">
        <h3>About</h3>
        <em>
          <p>This is my personal website. Nothing here is endorsed by my employer or organizations I am part of.</p>
          <p>Content on this site is released under a
            <a href="https://creativecommons.org/licenses/by/4.0/legalcode">CC-BY 4.0 license.</a>
            Source code of the site is provided under the <a href="https://opensource.org/licenses/MIT">MIT license</a>
            and may be reused without restriction.</p>
          <p>Huge thanks to Noam Ross for the beautifully designed website and detailed instruction on how to built it <a href="https://www.noamross.net/2019/08/09/a-new-website/">here</a>.</p>
        </em>
      </div>
      <div class="is-col is-33">
        <h3 id="connect">Connect</h3>
        <ul class="fa-ul">
          <li><i class="fa-li fas fa-briefcase fa-fw"></i>3700 Hamilton Walk, Philadelphia, PA 19104</li>
          <li><i class="fa-li fas fa-envelope fa-fw"></i><a href="mailto:grixor@gmail.com">grixor@gmail.com</a></li>
          <li><a href="https://orcid.org/0000-0003-3737-6565"><i class="fa-li ai ai-orcid"></i></a><a href="https://orcid.org/0000-0003-3737-6565">0000-0003-3737-6565</a></li>
          <li><a href="https://scholar.google.com/citations?user=OMpJVfsAAAAJ&hl=en"><i class="fa-li ai ai-google-scholar"></i></a><a href="https://scholar.google.com/citations?user=OMpJVfsAAAAJ">Google Scholar</a></li>
          <li><a href="https://twitter.com/trang1618"><i class="fa-li fab fa-twitter fa-fw"></i></a><a href="https://twitter.com/trang1618">@trang1618</a></li>
          <li><a href="https://github.com/trang1618"><i class="fa-li fab fa-github fa-fw"></i></a><a href="https://github.com/trang1618">github.com/trang1618</a>
          <li><a href="https://slides.com/trang1618"><i class="fa-li fas fa-object-ungroup fa-fw"></i></a><a href="https://slides.com/trang1618">slides.com/trang1618</a>
        </ul>
      </div>
      <div class="is-col is-33">
        <h3 id="subscribe">Subscribe</h3>
        <em><p>Follow me on Twitter at <a href="https://twitter.com/trang1618">@trang1618</a> where I'll update you if anything is posted.</p></em>
        <h3 id="search">Search</h3>
        <nav class="is-push-right is-left-mobile" class="is-hidden-mobile">
					<form method="get" action="https://duckduckgo.com/">
      <input type="search" name="q" maxlength="255" placeholder="Search on site">
      <input type="hidden" name="sites" value="www.trang1618.github.io" />
      <input type="hidden" name="ka" value="Alegreya" />
      <input type="hidden" name="k7" value="#faf8f8" />
      <input type="hidden" name="kj" value="#b33" />
      <input type="hidden" name="ky" value="#fafafa" />
      <input type="hidden" name="kx" value="b" />
      <input type="hidden" name="ko" value="-1" />
      <input type="hidden" name="k1" value="-1" />
      <input type="hidden" name="kt" value="Alegreya Sans" />
</form>
				</nav>
      </div>
    </div>
  </div>
</footer>

<script type="text/javascript" src="/assets/js/kube.js"></script>
<script>
  $K.dom(window).on('load', $K.init);
</script>


</body>
</html>
